<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fishing Tracker - Web App</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
        }
        
        .mobile-container {
            max-width: 375px;
            margin: 20px auto;
            background: white;
            min-height: 667px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            border-radius: 20px;
            overflow: hidden;
            position: relative;
        }
        
        .screen {
            display: none;
            flex-direction: column;
            height: 667px;
        }
        
        .screen.active { display: flex; }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 20px 20px;
            text-align: center;
        }
        
        .content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .bottom-nav {
            display: flex;
            background: white;
            border-top: 1px solid #e0e0e0;
            padding: 10px 0;
        }
        
        .nav-item {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            color: #666;
            font-size: 12px;
        }
        
        .nav-item.active { color: #667eea; }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        input, select {
            width: 100%;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        button {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 10px;
        }
        
        button:hover { background: #5a67d8; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        
        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }
        
        .btn-danger {
            background: #f44336;
        }
        
        .btn-success {
            background: #4CAF50;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-around;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .status-item {
            text-align: center;
        }
        
        .status-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        
        .status-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .session-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
        }
        
        .session-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .active-session {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .timer {
            font-size: 48px;
            font-weight: bold;
            margin: 20px 0;
        }
        
        .catch-entry {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .species-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .species-btn {
            padding: 8px 16px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .species-btn.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .gps-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background: #e8f5e9;
            color: #4CAF50;
            border-radius: 20px;
            font-size: 12px;
        }
        
        .pulse {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #4CAF50;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .message {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .message.success {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .message.error {
            background: #ffebee;
            color: #c62828;
        }
        
        .backend-status {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            background: rgba(255,255,255,0.9);
            border-radius: 20px;
            font-size: 11px;
            z-index: 100;
        }
        
        .backend-status.online { color: #4CAF50; }
        .backend-status.offline { color: #f44336; }
        
        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .map-placeholder {
            background: #e0e0e0;
            height: 200px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="mobile-container">
        <!-- Backend Status Indicator -->
        <div class="backend-status" id="backendStatus">
            <span class="pulse"></span> Checking...
        </div>

        <!-- Login Screen -->
        <div class="screen active" id="loginScreen">
            <div class="header">
                <h1>üé£ Fishing Tracker</h1>
                <p>Track your fishing adventures</p>
            </div>
            <div class="content">
                <div class="input-group">
                    <input type="email" id="loginEmail" placeholder="Email" value="demo@fishing.com">
                    <input type="password" id="loginPassword" placeholder="Password" value="demo123">
                </div>
                <button onclick="app.login()">Login</button>
                <button class="btn-secondary" onclick="app.showScreen('registerScreen')">Create Account</button>
                <div id="loginMessage"></div>
            </div>
        </div>

        <!-- Register Screen -->
        <div class="screen" id="registerScreen">
            <div class="header">
                <h2>Create Account</h2>
            </div>
            <div class="content">
                <div class="input-group">
                    <input type="email" id="regEmail" placeholder="Email">
                    <input type="password" id="regPassword" placeholder="Password">
                    <input type="password" id="regConfirm" placeholder="Confirm Password">
                </div>
                <button onclick="app.register()">Register</button>
                <button class="btn-secondary" onclick="app.showScreen('loginScreen')">Back to Login</button>
                <div id="regMessage"></div>
            </div>
        </div>

        <!-- Home Screen -->
        <div class="screen" id="homeScreen">
            <div class="header">
                <h2>Fishing Tracker</h2>
                <div class="gps-indicator" id="gpsStatus">
                    <span class="pulse"></span> GPS Ready
                </div>
            </div>
            <div class="content">
                <div class="status-bar">
                    <div class="status-item">
                        <div class="status-value" id="sessionCount">0</div>
                        <div class="status-label">Sessions</div>
                    </div>
                    <div class="status-item">
                        <div class="status-value" id="catchCount">0</div>
                        <div class="status-label">Catches</div>
                    </div>
                    <div class="status-item">
                        <div class="status-value" id="pointCount">0</div>
                        <div class="status-label">GPS Points</div>
                    </div>
                </div>
                
                <div id="sessionStatus"></div>
                
                <button id="sessionBtn" class="btn-success" onclick="app.toggleSession()">
                    Start Fishing Session
                </button>
                <button class="btn-secondary" onclick="app.syncData()">
                    Sync Data
                </button>
            </div>
            <div class="bottom-nav">
                <div class="nav-item active" onclick="app.showScreen('homeScreen')">
                    üè† Home
                </div>
                <div class="nav-item" onclick="app.showScreen('activeScreen')">
                    üìç Active
                </div>
                <div class="nav-item" onclick="app.showScreen('historyScreen')">
                    üìú History
                </div>
                <div class="nav-item" onclick="app.showScreen('settingsScreen')">
                    ‚öôÔ∏è Settings
                </div>
            </div>
        </div>

        <!-- Active Session Screen -->
        <div class="screen" id="activeScreen">
            <div class="header">
                <h2>Active Session</h2>
            </div>
            <div class="content">
                <div id="sessionStatusArea">
                    <!-- Session status will be dynamically updated -->
                </div>
                
                <div class="map-placeholder">
                    <span>üìç Map View (GPS Tracking)</span>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <button id="photoBtn" style="background: #9C27B0; font-size: 18px;" onclick="app.capturePhoto()">üì∏ Take Photo</button>
                    <button id="catchBtn" style="background: #4CAF50; font-size: 18px;" onclick="app.showAddCatch()">üêü Log Catch</button>
                </div>
                <button id="endSessionBtn" class="btn-danger" onclick="app.endSession()" style="display: none;">End Session</button>
                <button id="startSessionBtn" class="btn-success" onclick="app.startSessionFromActive()" style="display: none;">Start New Session</button>
                
                <div id="catchList"></div>
            </div>
            <div class="bottom-nav">
                <div class="nav-item" onclick="app.showScreen('homeScreen')">
                    üè† Home
                </div>
                <div class="nav-item active" onclick="app.showScreen('activeScreen')">
                    üìç Active
                </div>
                <div class="nav-item" onclick="app.showScreen('historyScreen')">
                    üìú History
                </div>
                <div class="nav-item" onclick="app.showScreen('settingsScreen')">
                    ‚öôÔ∏è Settings
                </div>
            </div>
        </div>

        <!-- Add Catch Modal -->
        <div class="screen" id="addCatchScreen">
            <div class="header">
                <h2>Log Catch</h2>
            </div>
            <div class="content">
                <label>Region Filter:</label>
                <select id="regionFilter" onchange="app.filterSpeciesByRegion()" style="width: 100%; padding: 10px; margin-bottom: 15px; border-radius: 5px; border: 1px solid #ddd;">
                    <option value="all">All Species</option>
                    <option value="pacific-nw-salt">Pacific Northwest - Saltwater</option>
                    <option value="pacific-nw-fresh">Pacific Northwest - Freshwater</option>
                    <option value="atlantic-north">Atlantic North (Maine to Virginia)</option>
                    <option value="atlantic-south">Atlantic South (Carolinas to Florida)</option>
                    <option value="gulf">Gulf of America</option>
                    <option value="hawaii">Hawaii & Pacific Islands</option>
                    <option value="great-lakes">Great Lakes</option>
                    <option value="southern-fresh">Southern Freshwater</option>
                    <option value="rockies">Rocky Mountain Waters</option>
                </select>
                
                <label>Species:</label>
                <div class="species-selector" id="speciesSelector">
                    <!-- Species buttons will be dynamically populated -->
                </div>
                
                <input type="number" id="catchLength" placeholder="Length (inches)" oninput="app.calculateHalibutWeight()">
                <input type="number" id="catchWeight" placeholder="Weight (lbs) - Optional">
                <div id="weightNote" style="color: #666; font-size: 12px; margin-top: -10px; margin-bottom: 10px; display: none;">
                    Auto-calculated for halibut based on length
                </div>
                <input type="number" id="catchDepth" placeholder="Depth (feet) - Optional" min="0" max="2000">
                <input type="text" id="catchNotes" placeholder="Notes - Optional">
                
                <button onclick="app.saveCatch()">Save Catch</button>
                <button class="btn-secondary" onclick="app.showScreen('activeScreen')">Cancel</button>
            </div>
        </div>

        <!-- History Screen -->
        <div class="screen" id="historyScreen">
            <div class="header">
                <h2>Session History</h2>
            </div>
            <div class="content">
                <div class="history-list" id="historyList">
                    <p style="text-align: center; color: #666;">No sessions yet</p>
                </div>
            </div>
            <div class="bottom-nav">
                <div class="nav-item" onclick="app.showScreen('homeScreen')">
                    üè† Home
                </div>
                <div class="nav-item" onclick="app.showScreen('activeScreen')">
                    üìç Active
                </div>
                <div class="nav-item active" onclick="app.showScreen('historyScreen')">
                    üìú History
                </div>
                <div class="nav-item" onclick="app.showScreen('settingsScreen')">
                    ‚öôÔ∏è Settings
                </div>
            </div>
        </div>

        <!-- Settings Screen -->
        <div class="screen" id="settingsScreen">
            <div class="header">
                <h2>Settings</h2>
            </div>
            <div class="content">
                <div style="margin-bottom: 20px;">
                    <h3>Account</h3>
                    <p id="userEmail" style="color: #666; margin: 10px 0;"></p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h3>Units</h3>
                    <select id="unitsSelect" onchange="app.updateUnits()">
                        <option value="imperial">Imperial (in/lb)</option>
                        <option value="metric">Metric (cm/kg)</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h3>Preferred Fishing Region</h3>
                    <select id="regionSelect" onchange="app.updatePreferredRegion()" style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ddd;">
                        <option value="pacific-nw-salt">Pacific Northwest - Saltwater</option>
                        <option value="pacific-nw-fresh">Pacific Northwest - Freshwater</option>
                        <option value="atlantic-north">Atlantic North (Maine to Virginia)</option>
                        <option value="atlantic-south">Atlantic South (Carolinas to Florida)</option>
                        <option value="gulf">Gulf of America</option>
                        <option value="hawaii">Hawaii & Pacific Islands</option>
                        <option value="great-lakes">Great Lakes</option>
                        <option value="southern-fresh">Southern Freshwater</option>
                        <option value="rockies">Rocky Mountain Waters</option>
                        <option value="all">All Regions</option>
                    </select>
                    <small style="color: #666;">This sets your default species list when logging catches</small>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h3>Sync Settings</h3>
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="autoSync" checked>
                        <span>Auto-sync when online</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
                        <input type="checkbox" id="wifiOnly">
                        <span>Wi-Fi only</span>
                    </label>
                </div>
                
                <button class="btn-secondary" onclick="app.exportData()">Export Data</button>
                <button class="btn-secondary" onclick="app.clearCache()">Clear Cache</button>
                <button class="btn-danger" onclick="app.logout()">Logout</button>
            </div>
            <div class="bottom-nav">
                <div class="nav-item" onclick="app.showScreen('homeScreen')">
                    üè† Home
                </div>
                <div class="nav-item" onclick="app.showScreen('activeScreen')">
                    üìç Active
                </div>
                <div class="nav-item" onclick="app.showScreen('historyScreen')">
                    üìú History
                </div>
                <div class="nav-item active" onclick="app.showScreen('settingsScreen')">
                    ‚öôÔ∏è Settings
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        
        const app = {
            currentUser: null,
            authToken: null,
            activeSession: null,
            sessions: [],
            catches: [],
            gpsPoints: [],
            selectedSpecies: null,
            sessionTimer: null,
            gpsInterval: null,
            
            // Comprehensive species database by region
            speciesDatabase: {
                'pacific-nw-salt': [
                    'Halibut', 'Lingcod', 'Rockfish', 'Chinook Salmon', 'Coho Salmon', 
                    'Pink Salmon', 'Chum Salmon', 'Sockeye Salmon', 'Dungeness Crab',
                    'Spot Shrimp', 'Black Cod', 'Cabezon', 'Greenling', 'Flounder',
                    'Sole', 'Skate', 'Dogfish', 'Ratfish', 'Octopus', 'Sea Bass'
                ],
                'pacific-nw-fresh': [
                    'Rainbow Trout', 'Cutthroat Trout', 'Steelhead', 'Brook Trout',
                    'Bull Trout', 'Lake Trout', 'Kokanee', 'Sturgeon', 'Smallmouth Bass',
                    'Largemouth Bass', 'Walleye', 'Northern Pike', 'Yellow Perch',
                    'Crappie', 'Bluegill', 'Catfish', 'Whitefish'
                ],
                'atlantic-north': [
                    'Striped Bass', 'Bluefish', 'Atlantic Cod', 'Haddock', 'Pollock',
                    'Flounder', 'Fluke', 'Scup', 'Tautog', 'Black Sea Bass',
                    'Weakfish', 'Atlantic Mackerel', 'Atlantic Bonito', 'False Albacore',
                    'Lobster', 'Blue Crab', 'Clams', 'Mussels', 'Oysters'
                ],
                'atlantic-south': [
                    'Red Drum', 'Spotted Seatrout', 'Flounder', 'Sheepshead', 'Black Drum',
                    'Pompano', 'Permit', 'Cobia', 'King Mackerel', 'Spanish Mackerel',
                    'Tarpon', 'Snook', 'Grouper', 'Snapper', 'Amberjack',
                    'Tripletail', 'Bluefish', 'Jack Crevalle', 'Ladyfish'
                ],
                'gulf': [
                    'Red Snapper', 'Grouper', 'King Mackerel', 'Spanish Mackerel',
                    'Cobia', 'Amberjack', 'Mahi Mahi', 'Wahoo', 'Tuna',
                    'Red Drum', 'Speckled Trout', 'Flounder', 'Sheepshead', 'Tripletail',
                    'Tarpon', 'Pompano', 'Permit', 'Jack Crevalle', 'Shark'
                ],
                'hawaii': [
                    'Mahi Mahi', 'Ahi (Yellowfin)', 'Aku (Skipjack)', 'Ono (Wahoo)',
                    'Blue Marlin', 'Striped Marlin', 'Spearfish', 'Sailfish',
                    'Ulua (Giant Trevally)', 'Papio (Trevally)', 'Bonefish', 'Barracuda',
                    'Opah', 'Monchong', 'Opakapaka', 'Onaga', 'Uku', 'Nabeta', 'Kawakawa'
                ],
                'great-lakes': [
                    'Lake Trout', 'Brown Trout', 'Rainbow Trout', 'Steelhead',
                    'Chinook Salmon', 'Coho Salmon', 'Atlantic Salmon', 'Walleye',
                    'Yellow Perch', 'Northern Pike', 'Muskie', 'Smallmouth Bass',
                    'Largemouth Bass', 'Rock Bass', 'White Perch', 'White Bass',
                    'Channel Catfish', 'Lake Sturgeon', 'Burbot', 'Whitefish'
                ],
                'southern-fresh': [
                    'Largemouth Bass', 'Spotted Bass', 'Smallmouth Bass', 'Striped Bass',
                    'White Bass', 'Crappie', 'Bluegill', 'Redear Sunfish',
                    'Channel Catfish', 'Blue Catfish', 'Flathead Catfish', 'Bullhead',
                    'White Perch', 'Yellow Perch', 'Freshwater Drum', 'Gar',
                    'Bowfin', 'Paddlefish', 'Buffalo', 'Carp'
                ],
                'rockies': [
                    'Rainbow Trout', 'Brown Trout', 'Brook Trout', 'Cutthroat Trout',
                    'Bull Trout', 'Lake Trout', 'Golden Trout', 'Arctic Grayling',
                    'Mountain Whitefish', 'Kokanee Salmon', 'Northern Pike', 'Walleye',
                    'Yellow Perch', 'Smallmouth Bass', 'Largemouth Bass', 'Tiger Muskie'
                ]
            },
            
            init() {
                this.checkBackendStatus();
                setInterval(() => this.checkBackendStatus(), 30000);
                this.loadFromLocalStorage();
                
                // Set imperial units as default
                const unitsSelect = document.getElementById('unitsSelect');
                if (unitsSelect && !localStorage.getItem('units')) {
                    localStorage.setItem('units', 'imperial');
                }
                
                if (this.authToken) {
                    this.showScreen('homeScreen');
                    this.updateStats();
                }
            },
            
            async checkBackendStatus() {
                const statusEl = document.getElementById('backendStatus');
                try {
                    const response = await fetch(`${API_URL}/health`);
                    if (response.ok) {
                        statusEl.className = 'backend-status online';
                        statusEl.innerHTML = '<span class="pulse"></span> Backend Online';
                    }
                } catch (error) {
                    statusEl.className = 'backend-status offline';
                    statusEl.innerHTML = 'Backend Offline';
                }
            },
            
            showScreen(screenId) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(screenId).classList.add('active');
                
                // Update nav
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                
                if (screenId === 'historyScreen') {
                    this.loadHistory();
                }
                if (screenId === 'activeScreen') {
                    this.updateActiveSessionDisplay();
                }
                if (screenId === 'settingsScreen') {
                    // Load saved settings
                    const units = localStorage.getItem('units') || 'imperial';
                    document.getElementById('unitsSelect').value = units;
                    
                    const region = localStorage.getItem('preferredRegion') || 'pacific-nw-salt';
                    document.getElementById('regionSelect').value = region;
                    
                    if (this.currentUser) {
                        document.getElementById('userEmail').textContent = this.currentUser;
                    }
                }
            },
            
            showMessage(elementId, message, type = 'success') {
                const el = document.getElementById(elementId);
                if (el) {
                    el.className = `message ${type}`;
                    el.textContent = message;
                    setTimeout(() => el.textContent = '', 3000);
                }
            },
            
            async login() {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                try {
                    const response = await fetch(`${API_URL}/auth/login`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({email, password})
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.authToken = data.access_token;
                        this.currentUser = email;
                        this.saveToLocalStorage();
                        this.showScreen('homeScreen');
                        this.updateStats();
                        document.getElementById('userEmail').textContent = email;
                    } else {
                        // Try registration if login fails
                        await this.quickRegister(email, password);
                    }
                } catch (error) {
                    this.showMessage('loginMessage', 'Backend offline - using local mode', 'error');
                    // Allow local-only mode
                    this.currentUser = email;
                    this.authToken = 'local-' + Date.now();
                    this.saveToLocalStorage();
                    this.showScreen('homeScreen');
                    this.updateStats();
                }
            },
            
            async quickRegister(email, password) {
                try {
                    const response = await fetch(`${API_URL}/auth/register`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({email, password})
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.authToken = data.access_token;
                        this.currentUser = email;
                        this.saveToLocalStorage();
                        this.showScreen('homeScreen');
                        this.updateStats();
                    }
                } catch (error) {
                    console.error('Registration error:', error);
                }
            },
            
            async register() {
                const email = document.getElementById('regEmail').value;
                const password = document.getElementById('regPassword').value;
                const confirm = document.getElementById('regConfirm').value;
                
                if (password !== confirm) {
                    this.showMessage('regMessage', 'Passwords do not match', 'error');
                    return;
                }
                
                try {
                    const response = await fetch(`${API_URL}/auth/register`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({email, password})
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.authToken = data.access_token;
                        this.currentUser = email;
                        this.saveToLocalStorage();
                        this.showScreen('homeScreen');
                        this.updateStats();
                    } else {
                        const error = await response.json();
                        this.showMessage('regMessage', error.error || 'Registration failed', 'error');
                    }
                } catch (error) {
                    this.showMessage('regMessage', 'Backend offline', 'error');
                }
            },
            
            logout() {
                this.currentUser = null;
                this.authToken = null;
                this.activeSession = null;
                this.clearLocalStorage();
                this.showScreen('loginScreen');
            },
            
            toggleSession() {
                if (this.activeSession) {
                    this.endSession();
                } else {
                    this.startSession();
                }
            },
            
            startSession() {
                this.activeSession = {
                    id: this.generateId(),
                    started_at: new Date().toISOString(),
                    title: `Session ${new Date().toLocaleDateString()}`,
                    gps_points: [],
                    catches: [],
                    photos: []
                };
                
                // Start GPS tracking
                this.startGPSTracking();
                
                // Start timer
                this.startTimer();
                
                // Update UI on home screen
                const sessionBtn = document.getElementById('sessionBtn');
                if (sessionBtn) {
                    sessionBtn.textContent = 'End Session';
                    sessionBtn.className = 'btn-danger';
                }
                
                const sessionStatus = document.getElementById('sessionStatus');
                if (sessionStatus) {
                    sessionStatus.innerHTML = `
                        <div class="message success">Session Active - GPS Tracking</div>
                    `;
                }
                
                // Update active session display if visible
                const photoBtn = document.getElementById('photoBtn');
                if (photoBtn) {
                    photoBtn.disabled = false;
                    photoBtn.style.opacity = '1';
                }
                const catchBtn = document.getElementById('catchBtn');
                if (catchBtn) {
                    catchBtn.disabled = false;
                    catchBtn.style.opacity = '1';
                }
                
                this.updateStats();
                this.saveToLocalStorage();
                
                // Update active session display if on that screen
                if (document.getElementById('activeScreen').classList.contains('active')) {
                    this.updateActiveSessionDisplay();
                }
            },
            
            endSession() {
                if (!this.activeSession) return;
                
                this.activeSession.ended_at = new Date().toISOString();
                this.sessions.push(this.activeSession);
                
                // Stop GPS and timer
                this.stopGPSTracking();
                this.stopTimer();
                
                // Update UI on home screen if it exists
                const sessionBtn = document.getElementById('sessionBtn');
                if (sessionBtn) {
                    sessionBtn.textContent = 'Start Fishing Session';
                    sessionBtn.className = 'btn-success';
                }
                
                const sessionStatus = document.getElementById('sessionStatus');
                if (sessionStatus) {
                    sessionStatus.innerHTML = `
                        <div class="message success">Session ended - ${this.activeSession.gps_points.length} GPS points recorded</div>
                    `;
                }
                
                this.activeSession = null;
                this.updateStats();
                this.saveToLocalStorage();
                
                // Update active session display if on that screen
                this.updateActiveSessionDisplay();
            },
            
            startGPSTracking() {
                // Simulate GPS tracking every 5 seconds (would be 5 minutes in real app)
                this.gpsInterval = setInterval(() => {
                    if (this.activeSession) {
                        const point = {
                            lat: 37.7749 + (Math.random() - 0.5) * 0.01,
                            lon: -122.4194 + (Math.random() - 0.5) * 0.01,
                            timestamp: new Date().toISOString(),
                            accuracy: Math.floor(Math.random() * 10) + 5
                        };
                        this.activeSession.gps_points.push(point);
                        this.gpsPoints.push(point);
                        this.updateStats();
                    }
                }, 5000); // Every 5 seconds for demo
            },
            
            stopGPSTracking() {
                if (this.gpsInterval) {
                    clearInterval(this.gpsInterval);
                    this.gpsInterval = null;
                }
            },
            
            startTimer() {
                const startTime = new Date(this.activeSession.started_at);
                this.sessionTimer = setInterval(() => {
                    const elapsed = Date.now() - startTime.getTime();
                    const hours = Math.floor(elapsed / 3600000);
                    const minutes = Math.floor((elapsed % 3600000) / 60000);
                    const seconds = Math.floor((elapsed % 60000) / 1000);
                    
                    const timerEl = document.getElementById('sessionTimer');
                    if (timerEl) {
                        timerEl.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    }
                }, 1000);
            },
            
            stopTimer() {
                if (this.sessionTimer) {
                    clearInterval(this.sessionTimer);
                    this.sessionTimer = null;
                }
            },
            
            showAddCatch() {
                if (!this.activeSession) {
                    alert('Please start a session first');
                    return;
                }
                // Clear form when showing
                document.getElementById('catchLength').value = '';
                document.getElementById('catchWeight').value = '';
                document.getElementById('catchDepth').value = '';
                document.getElementById('catchNotes').value = '';
                document.getElementById('weightNote').style.display = 'none';
                document.getElementById('catchWeight').placeholder = 'Weight (lbs) - Optional';
                this.selectedSpecies = null;
                document.querySelectorAll('.species-btn').forEach(b => b.classList.remove('selected'));
                
                // Load saved region preference or default to Pacific NW
                const savedRegion = localStorage.getItem('preferredRegion') || 'pacific-nw-salt';
                document.getElementById('regionFilter').value = savedRegion;
                this.filterSpeciesByRegion();
                
                this.showScreen('addCatchScreen');
            },
            
            filterSpeciesByRegion() {
                const regionFilter = document.getElementById('regionFilter');
                const selectedRegion = regionFilter.value;
                const speciesSelector = document.getElementById('speciesSelector');
                
                // Save preference
                localStorage.setItem('preferredRegion', selectedRegion);
                
                let speciesToShow = [];
                
                if (selectedRegion === 'all') {
                    // Combine all unique species
                    const allSpecies = new Set();
                    Object.values(this.speciesDatabase).forEach(regionSpecies => {
                        regionSpecies.forEach(species => allSpecies.add(species));
                    });
                    speciesToShow = Array.from(allSpecies).sort();
                } else if (this.speciesDatabase[selectedRegion]) {
                    speciesToShow = this.speciesDatabase[selectedRegion];
                }
                
                // Remove any existing "Other" entries and add it once at the end
                speciesToShow = speciesToShow.filter(species => species !== 'Other');
                speciesToShow.push('Other');
                
                // Clear and populate species buttons
                speciesSelector.innerHTML = '';
                speciesToShow.forEach(species => {
                    const btn = document.createElement('div');
                    btn.className = 'species-btn';
                    btn.textContent = species;
                    btn.onclick = () => this.selectSpecies(btn, species);
                    speciesSelector.appendChild(btn);
                });
            },
            
            selectSpecies(btn, species) {
                document.querySelectorAll('.species-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                this.selectedSpecies = species;
                
                // Show/hide weight note and trigger calculation for halibut
                const weightNote = document.getElementById('weightNote');
                const weightInput = document.getElementById('catchWeight');
                
                if (species === 'Halibut') {
                    this.calculateHalibutWeight();
                    if (weightNote) weightNote.style.display = 'block';
                } else {
                    if (weightNote) weightNote.style.display = 'none';
                    if (weightInput) weightInput.placeholder = 'Weight (lbs) - Optional';
                }
            },
            
            calculateHalibutWeight() {
                // Check if selected species is any type of halibut
                if (!this.selectedSpecies || !this.selectedSpecies.toLowerCase().includes('halibut')) return;
                
                const lengthInput = document.getElementById('catchLength');
                const weightInput = document.getElementById('catchWeight');
                
                if (!lengthInput || !weightInput) return;
                
                const length = parseFloat(lengthInput.value);
                if (!length || length <= 0) {
                    weightInput.value = '';
                    return;
                }
                
                // Halibut length to live weight lookup table based on official chart
                const halibutWeightTable = [
                    [18, 2.2], [20, 3.2], [22, 4.2], [24, 5.5], [25, 6.3],
                    [26, 7.2], [27, 8.2], [28, 9.2], [29, 10.3], [30, 11.5],
                    [31, 12.8], [32, 14.2], [33, 15.7], [34, 17.3], [35, 19.0],
                    [36, 20.9], [37, 22.7], [38, 24.8], [39, 27.0], [40, 29.3],
                    [41, 31.7], [42, 34.3], [43, 37.0], [44, 39.9], [45, 42.9],
                    [46, 46.0], [47, 49.3], [48, 52.7], [49, 56.3], [50, 60.3],
                    [51, 64.3], [52, 68.3], [53, 72.8], [54, 77.4], [55, 82.1],
                    [56, 87.0], [57, 92.2], [58, 97.5], [59, 103.1], [60, 108.9],
                    [61, 114.8], [62, 121.1], [63, 127.5], [64, 134.2], [65, 141.1],
                    [66, 148.2], [67, 155.6], [68, 163.3], [69, 171.2], [70, 179.4],
                    [71, 187.8], [72, 196.5], [73, 205.5], [74, 214.8], [75, 224.3],
                    [76, 234.1], [77, 244.3], [78, 254.7], [79, 265.4], [80, 276.5],
                    [81, 287.8], [82, 299.5], [83, 311.5], [84, 323.9], [85, 336.5],
                    [86, 349.5], [87, 362.9], [88, 376.5], [89, 390.6], [90, 404.9],
                    [91, 419.7], [92, 434.8], [93, 450.2], [94, 466.2], [95, 482.4],
                    [96, 499.1], [97, 516.2], [98, 533.6], [99, 551.5], [100, 569.7]
                ];
                
                let weight;
                
                // Find exact match or interpolate
                const exactMatch = halibutWeightTable.find(entry => entry[0] === Math.round(length));
                
                if (exactMatch) {
                    weight = exactMatch[1];
                } else if (length < 18) {
                    // For fish smaller than 18 inches, use cubic formula with adjustment
                    weight = Math.pow(length, 3) / 2600;
                } else if (length > 100) {
                    // For fish larger than 100 inches, extrapolate using trend
                    // Approximate using cubic growth with adjustment factor
                    const baseWeight = 569.7; // weight at 100 inches
                    const extraInches = length - 100;
                    // Each inch over 100 adds approximately 18-20 lbs
                    weight = baseWeight + (extraInches * 19);
                } else {
                    // Interpolate between two nearest values
                    const lowerLength = Math.floor(length);
                    const upperLength = Math.ceil(length);
                    
                    const lowerEntry = halibutWeightTable.find(entry => entry[0] === lowerLength);
                    const upperEntry = halibutWeightTable.find(entry => entry[0] === upperLength);
                    
                    if (lowerEntry && upperEntry) {
                        const fraction = length - lowerLength;
                        weight = lowerEntry[1] + (upperEntry[1] - lowerEntry[1]) * fraction;
                    } else {
                        // Fallback to cubic formula if entries not found
                        let divisor = length <= 30 ? 2400 : length <= 50 ? 2200 : length <= 70 ? 2000 : 1800;
                        weight = Math.pow(length, 3) / divisor;
                    }
                }
                
                // Round to 1 decimal place
                weightInput.value = Math.round(weight * 10) / 10;
                weightInput.placeholder = 'Auto-calculated from length';
            },
            
            saveCatch() {
                if (!this.selectedSpecies) {
                    alert('Please select a species');
                    return;
                }
                
                const catchData = {
                    id: this.generateId(),
                    species: this.selectedSpecies,
                    length: document.getElementById('catchLength').value,
                    weight: document.getElementById('catchWeight').value,
                    depth: document.getElementById('catchDepth').value,
                    notes: document.getElementById('catchNotes').value,
                    timestamp: new Date().toISOString(),
                    lat: 37.7749 + (Math.random() - 0.5) * 0.01,
                    lon: -122.4194 + (Math.random() - 0.5) * 0.01
                };
                
                if (this.activeSession) {
                    this.activeSession.catches.push(catchData);
                }
                this.catches.push(catchData);
                
                // Clear form
                document.getElementById('catchLength').value = '';
                document.getElementById('catchWeight').value = '';
                document.getElementById('catchDepth').value = '';
                document.getElementById('catchNotes').value = '';
                this.selectedSpecies = null;
                
                this.updateStats();
                this.saveToLocalStorage();
                this.showScreen('activeScreen');
                
                // Update catch list
                this.updateCatchList();
            },
            
            updateCatchList() {
                const listEl = document.getElementById('catchList');
                if (!listEl || !this.activeSession) return;
                
                if (this.activeSession.catches.length === 0) {
                    listEl.innerHTML = '<p style="text-align: center; color: #666;">No catches yet</p>';
                } else {
                    const units = localStorage.getItem('units') || 'imperial';
                    const lengthUnit = units === 'imperial' ? 'in' : 'cm';
                    const weightUnit = units === 'imperial' ? 'lbs' : 'kg';
                    
                    listEl.innerHTML = '<h3>Catches</h3>' + 
                        this.activeSession.catches.map(c => `
                            <div class="catch-entry">
                                <strong>${c.species}</strong>
                                ${c.length ? ` - ${c.length}${lengthUnit}` : ''}
                                ${c.weight ? ` - ${c.weight}${weightUnit}` : ''}
                                ${c.depth ? ` - ${c.depth}ft deep` : ''}
                                ${c.notes ? `<br><small>${c.notes}</small>` : ''}
                            </div>
                        `).join('');
                }
            },
            
            updateActiveSessionDisplay() {
                const statusArea = document.getElementById('sessionStatusArea');
                const photoBtn = document.getElementById('photoBtn');
                const catchBtn = document.getElementById('catchBtn');
                const endBtn = document.getElementById('endSessionBtn');
                const startBtn = document.getElementById('startSessionBtn');
                
                if (this.activeSession) {
                    // Show active session info
                    statusArea.innerHTML = `
                        <div class="active-session">
                            <h3>Session Active</h3>
                            <div class="timer" id="sessionTimer">00:00:00</div>
                            <div class="gps-indicator">
                                <span class="pulse"></span> Tracking GPS (${this.activeSession.gps_points?.length || 0} points)
                            </div>
                        </div>
                    `;
                    
                    // Enable buttons
                    photoBtn.disabled = false;
                    catchBtn.disabled = false;
                    endBtn.style.display = 'block';
                    startBtn.style.display = 'none';
                    
                    // Restart timer if needed
                    if (!this.sessionTimer) {
                        this.startTimer();
                    }
                    
                    // Update catch list
                    this.updateCatchList();
                } else {
                    // Show no session message
                    statusArea.innerHTML = `
                        <div class="message" style="text-align: center; padding: 20px;">
                            <h3>No Active Session</h3>
                            <p style="color: #666; margin-top: 10px;">Start a new session to begin tracking</p>
                        </div>
                    `;
                    
                    // Disable buttons
                    photoBtn.disabled = true;
                    photoBtn.style.opacity = '0.5';
                    catchBtn.disabled = true;
                    catchBtn.style.opacity = '0.5';
                    endBtn.style.display = 'none';
                    startBtn.style.display = 'block';
                    
                    document.getElementById('catchList').innerHTML = '';
                }
            },
            
            startSessionFromActive() {
                this.startSession();
                this.updateActiveSessionDisplay();
            },
            
            capturePhoto() {
                if (!this.activeSession) {
                    alert('Please start a session first');
                    return;
                }
                
                // Simulate photo capture
                const photoCount = (this.activeSession?.photos || []).length + 1;
                const photo = {
                    id: this.generateId(),
                    timestamp: new Date().toISOString(),
                    lat: 37.7749 + (Math.random() - 0.5) * 0.01,
                    lon: -122.4194 + (Math.random() - 0.5) * 0.01,
                    filename: `catch_photo_${photoCount}.jpg`
                };
                
                if (this.activeSession) {
                    if (!this.activeSession.photos) this.activeSession.photos = [];
                    this.activeSession.photos.push(photo);
                }
                
                // Show feedback
                const catchListEl = document.getElementById('catchList');
                if (catchListEl) {
                    const photoMsg = document.createElement('div');
                    photoMsg.className = 'message success';
                    photoMsg.textContent = `üì∏ Photo captured! (${photo.filename})`;
                    photoMsg.style.marginTop = '10px';
                    catchListEl.insertBefore(photoMsg, catchListEl.firstChild);
                    setTimeout(() => photoMsg.remove(), 3000);
                }
                
                this.saveToLocalStorage();
            },
            
            loadHistory() {
                const listEl = document.getElementById('historyList');
                if (this.sessions.length === 0) {
                    listEl.innerHTML = '<p style="text-align: center; color: #666;">No sessions yet</p>';
                } else {
                    listEl.innerHTML = this.sessions.map(s => `
                        <div class="session-card" onclick="app.viewSession('${s.id}')">
                            <h4>${s.title}</h4>
                            <p>Date: ${new Date(s.started_at).toLocaleDateString()}</p>
                            <p>Duration: ${this.calculateDuration(s.started_at, s.ended_at)}</p>
                            <p>GPS Points: ${s.gps_points.length} | Catches: ${s.catches.length}</p>
                        </div>
                    `).join('');
                }
            },
            
            viewSession(sessionId) {
                const session = this.sessions.find(s => s.id === sessionId);
                if (session) {
                    alert(`Session Details:\n
Title: ${session.title}
Started: ${new Date(session.started_at).toLocaleString()}
Duration: ${this.calculateDuration(session.started_at, session.ended_at)}
GPS Points: ${session.gps_points.length}
Catches: ${session.catches.length}
${session.catches.map(c => `\n- ${c.species} ${c.length ? c.length + 'in' : ''} ${c.weight ? c.weight + 'lbs' : ''} ${c.depth ? '@' + c.depth + 'ft' : ''}`).join('')}`);
                }
            },
            
            calculateDuration(start, end) {
                if (!end) return 'Active';
                const ms = new Date(end) - new Date(start);
                const hours = Math.floor(ms / 3600000);
                const minutes = Math.floor((ms % 3600000) / 60000);
                return hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
            },
            
            async syncData() {
                alert('Sync would upload:\n' +
                    `- ${this.sessions.length} sessions\n` +
                    `- ${this.gpsPoints.length} GPS points\n` +
                    `- ${this.catches.length} catches\n\n` +
                    'And download any server changes');
            },
            
            updateStats() {
                document.getElementById('sessionCount').textContent = this.sessions.length;
                document.getElementById('catchCount').textContent = this.catches.length;
                document.getElementById('pointCount').textContent = this.gpsPoints.length;
            },
            
            updateUnits() {
                const units = document.getElementById('unitsSelect').value;
                localStorage.setItem('units', units);
                alert(`Units changed to ${units}`);
            },
            
            updatePreferredRegion() {
                const region = document.getElementById('regionSelect').value;
                localStorage.setItem('preferredRegion', region);
                alert(`Preferred region set to ${document.getElementById('regionSelect').options[document.getElementById('regionSelect').selectedIndex].text}`);
            },
            
            exportData() {
                const data = {
                    sessions: this.sessions,
                    catches: this.catches,
                    gps_points: this.gpsPoints,
                    exported_at: new Date().toISOString()
                };
                const json = JSON.stringify(data, null, 2);
                const blob = new Blob([json], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `fishing-data-${Date.now()}.json`;
                a.click();
            },
            
            clearCache() {
                if (confirm('Clear all cached data?')) {
                    this.sessions = [];
                    this.catches = [];
                    this.gpsPoints = [];
                    this.updateStats();
                    this.saveToLocalStorage();
                    alert('Cache cleared');
                }
            },
            
            generateId() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    const r = Math.random() * 16 | 0;
                    const v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            },
            
            saveToLocalStorage() {
                localStorage.setItem('fishingApp', JSON.stringify({
                    currentUser: this.currentUser,
                    authToken: this.authToken,
                    activeSession: this.activeSession,
                    sessions: this.sessions,
                    catches: this.catches,
                    gpsPoints: this.gpsPoints
                }));
            },
            
            loadFromLocalStorage() {
                const data = localStorage.getItem('fishingApp');
                if (data) {
                    const parsed = JSON.parse(data);
                    this.currentUser = parsed.currentUser;
                    this.authToken = parsed.authToken;
                    this.activeSession = parsed.activeSession;
                    this.sessions = parsed.sessions || [];
                    this.catches = parsed.catches || [];
                    this.gpsPoints = parsed.gpsPoints || [];
                }
            },
            
            clearLocalStorage() {
                localStorage.removeItem('fishingApp');
            }
        };
        
        // Initialize app
        app.init();
    </script>
</body>
</html>